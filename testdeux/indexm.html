<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcul Employés RoxWood et Paleto</title>
</head>
<body>
    <h2>RoxWood</h2>
    <div id="roxwood-factures">Total des factures: </div>
    <div id="roxwood-ca">Chiffre d'affaire généré: </div>
    <div id="roxwood-achats">Chiffre d'achat: </div>
    <div id="roxwood-benefice-brut">Bénéfice brut: </div>
    <div id="roxwood-benefice-net">Bénéfice net: </div>

    <h2>Paleto</h2>
    <div id="paleto-factures">Total des factures: </div>
    <div id="paleto-ca">Chiffre d'affaire généré: </div>
    <div id="paleto-achats">Chiffre d'achat: </div>
    <div id="paleto-benefice-brut">Bénéfice brut: </div>
    <div id="paleto-benefice-net">Bénéfice net: </div>

    <script>
        // URL des CSV Google Sheets
        const urlTableau1 = 'https://docs.google.com/spreadsheets/d/1M19pAtJYNnDCaKxhO5XjWIlxqT7p2zvk6FHqKYVBJ1g/export?format=csv&gid=821726330';
        const urlTableau2 = 'https://docs.google.com/spreadsheets/d/1M19pAtJYNnDCaKxhO5XjWIlxqT7p2zvk6FHqKYVBJ1g/export?format=csv&gid=582059801';

        // Variables pour stocker les données
        let employesRoxwood = [];
        let employesPaleto = [];

        function logAction(message) {
            console.log(message);
        }

        // Fonction pour récupérer les données CSV et les transformer en tableau
        async function fetchCSV(url) {
            logAction(`Fetching data from ${url}`);
            const response = await fetch(url);
            const data = await response.text();
            return data.split('\n').map(row => row.split(','));
        }

        // Fonction pour vérifier si une ligne est valide (sans éléments indésirables)
        function isValidRow(row) {
            const invalidPattern = /\{.*\}/; // RegEx pour détecter les lignes contenant des accolades
            const unwantedKeywords = ["Pourcentage", "Prix de craft", "$"]; // Mots-clés à ignorer
            return !invalidPattern.test(row.join(',')) && !unwantedKeywords.some(keyword => row.join(',').includes(keyword));
        }

        // Fonction principale
        async function processData() {
            const tableau1 = await fetchCSV(urlTableau1);
            const tableau2 = await fetchCSV(urlTableau2);

            // Extraction des identifiants d'employés depuis le Tableau 1
            tableau1.forEach(row => {
                if (isValidRow(row)) { // Vérifie si la ligne est valide
                    const identifiant = row[3]; // Colonne D
                    const isRoxwood = row[22] === 'TRUE'; // Colonne W
                    if (identifiant) { // Ignore les lignes sans identifiant
                        if (isRoxwood) {
                            employesRoxwood.push(identifiant);
                        } else {
                            employesPaleto.push(identifiant);
                        }
                    }
                }
            });
            logAction(`Employés de Roxwood: ${employesRoxwood.join(', ')}`);
            logAction(`Employés de Paleto: ${employesPaleto.join(', ')}`);

            // Calculs pour Roxwood
            let roxwoodFactures = 0, roxwoodCA = 0, roxwoodAchats = 0, roxwoodBeneficeBrut = 0, roxwoodSalaires = 0;
            tableau2.forEach(row => {
                if (isValidRow(row)) { // Vérifie si la ligne est valide
                    const identifiant = row[2]; // Colonne C
                    if (employesRoxwood.includes(identifiant)) {
                        roxwoodFactures += parseFloat(row[4]) || 0; // Colonne E
                        roxwoodCA += parseFloat(row[5]) || 0; // Colonne F
                        roxwoodAchats += parseFloat(row[7]) || 0; // Colonne H
                        roxwoodBeneficeBrut += parseFloat(row[9]) || 0; // Colonne J
                        roxwoodSalaires += parseFloat(row[22]) || 0; // Colonne W
                    }
                }
            });
            logAction(`Total des factures Roxwood: ${roxwoodFactures}`);
            logAction(`Chiffre d'affaire Roxwood: ${roxwoodCA}`);
            logAction(`Chiffre d'achat Roxwood: ${roxwoodAchats}`);
            logAction(`Bénéfice brut Roxwood: ${roxwoodBeneficeBrut}`);
            logAction(`Salaires Roxwood: ${roxwoodSalaires}`);
            const roxwoodBeneficeNet = roxwoodBeneficeBrut - roxwoodSalaires;

            // Mise à jour des divs Roxwood
            document.getElementById('roxwood-factures').textContent += roxwoodFactures;
            document.getElementById('roxwood-ca').textContent += roxwoodCA;
            document.getElementById('roxwood-achats').textContent += roxwoodAchats;
            document.getElementById('roxwood-benefice-brut').textContent += roxwoodBeneficeBrut;
            document.getElementById('roxwood-benefice-net').textContent += roxwoodBeneficeNet;

            // Calculs pour Paleto
            let paletoFactures = 0, paletoCA = 0, paletoAchats = 0, paletoBeneficeBrut = 0, paletoSalaires = 0;
            tableau2.forEach(row => {
                if (isValidRow(row)) { // Vérifie si la ligne est valide
                    const identifiant = row[2]; // Colonne C
                    if (employesPaleto.includes(identifiant)) {
                        paletoFactures += parseFloat(row[4]) || 0; // Colonne E
                        paletoCA += parseFloat(row[5]) || 0; // Colonne F
                        paletoAchats += parseFloat(row[7]) || 0; // Colonne H
                        paletoBeneficeBrut += parseFloat(row[9]) || 0; // Colonne J
                        paletoSalaires += parseFloat(row[22]) || 0; // Colonne W
                    }
                }
            });
            logAction(`Total des factures Paleto: ${paletoFactures}`);
            logAction(`Chiffre d'affaire Paleto: ${paletoCA}`);
            logAction(`Chiffre d'achat Paleto: ${paletoAchats}`);
            logAction(`Bénéfice brut Paleto: ${paletoBeneficeBrut}`);
            logAction(`Salaires Paleto: ${paletoSalaires}`);
            const paletoBeneficeNet = paletoBeneficeBrut - paletoSalaires;

            // Mise à jour des divs Paleto
            document.getElementById('paleto-factures').textContent += paletoFactures;
            document.getElementById('paleto-ca').textContent += paletoCA;
            document.getElementById('paleto-achats').textContent += paletoAchats;
            document.getElementById('paleto-benefice-brut').textContent += paletoBeneficeBrut;
            document.getElementById('paleto-benefice-net').textContent += paletoBeneficeNet;
        }

        // Lancer le traitement
        processData();
    </script>
</body>
</html>
