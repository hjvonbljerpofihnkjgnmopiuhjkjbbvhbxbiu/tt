<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Récupération des Données Employés</title>
</head>
<body>
    <h1>Informations sur les employés</h1>

    <div id="roxwoodResults">
        <h2>Employés de Roxwood</h2>
        <div>Nombre total de factures : <span id="roxwoodFactures"></span></div>
        <div>Chiffre d'affaires généré : <span id="roxwoodChiffreAffaire"></span></div>
        <div>Chiffre d'achat total : <span id="roxwoodChiffreAchat"></span></div>
        <div>Bénéfice brut : <span id="roxwoodBeneficeBrut"></span></div>
        <div>Bénéfice net : <span id="roxwoodBeneficeNet"></span></div>
    </div>

    <div id="paletoResults">
        <h2>Employés de Paleto</h2>
        <div>Nombre total de factures : <span id="paletoFactures"></span></div>
        <div>Chiffre d'affaires généré : <span id="paletoChiffreAffaire"></span></div>
        <div>Chiffre d'achat total : <span id="paletoChiffreAchat"></span></div>
        <div>Bénéfice brut : <span id="paletoBeneficeBrut"></span></div>
        <div>Bénéfice net : <span id="paletoBeneficeNet"></span></div>
    </div>

    <script>
        // URLs des tableaux CSV
        const tableau1URL = 'https://docs.google.com/spreadsheets/d/1M19pAtJYNnDCaKxhO5XjWIlxqT7p2zvk6FHqKYVBJ1g/export?format=csv&gid=821726330';
        const tableau2URL = 'https://docs.google.com/spreadsheets/d/1M19pAtJYNnDCaKxhO5XjWIlxqT7p2zvk6FHqKYVBJ1g/export?format=csv&gid=582059801';

        // Fonction pour parser le CSV en un tableau d'objets
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const data = line.split(',');
                return headers.reduce((obj, header, index) => {
                    obj[header.trim()] = data[index]?.trim();
                    return obj;
                }, {});
            });
        }

        // Fonction principale pour récupérer et traiter les données
        async function fetchData() {
            console.log('Démarrage du script');
            
            try {
                const [response1, response2] = await Promise.all([
                    fetch(tableau1URL),
                    fetch(tableau2URL)
                ]);

                const tableau1 = parseCSV(await response1.text());
                const tableau2 = parseCSV(await response2.text());

                console.log('Données récupérées des deux tableaux');

                const roxwoodIDs = tableau1
                    .filter(row => row['D'] && row['W'] === 'TRUE')
                    .map(row => row['D']);
                console.log('Identifiants employés de Roxwood:', roxwoodIDs);

                const paletoIDs = tableau1
                    .filter(row => row['D'] && row['W'] === 'FALSE')
                    .map(row => row['D']);
                console.log('Identifiants employés de Paleto:', paletoIDs);

                calculateAndDisplayResults(roxwoodIDs, tableau2, 'roxwood');
                calculateAndDisplayResults(paletoIDs, tableau2, 'paleto');
            } catch (error) {
                console.error('Erreur lors de la récupération des données:', error);
            }
        }

        // Fonction pour calculer et afficher les résultats
        function calculateAndDisplayResults(ids, tableau, type) {
            let totalFactures = 0;
            let totalChiffreAffaire = 0;
            let totalChiffreAchat = 0;
            let totalBenefice = 0;
            let totalSalaires = 0;

            tableau.forEach(row => {
                if (ids.includes(row['C'])) {
                    totalFactures += parseFloat(row['E']) || 0;
                    totalChiffreAffaire += parseFloat(row['F']) || 0;
                    totalChiffreAchat += parseFloat(row['H']) || 0;
                    totalBenefice += parseFloat(row['J']) || 0;
                    totalSalaires += parseFloat(row['W']) || 0;
                }
            });

            const beneficeNet = totalBenefice - totalSalaires;

            document.getElementById(`${type}Factures`).textContent = totalFactures;
            document.getElementById(`${type}ChiffreAffaire`).textContent = totalChiffreAffaire;
            document.getElementById(`${type}ChiffreAchat`).textContent = totalChiffreAchat;
            document.getElementById(`${type}BeneficeBrut`).textContent = totalBenefice;
            document.getElementById(`${type}BeneficeNet`).textContent = beneficeNet;

            console.log(`Résultats pour ${type} calculés et affichés.`);
        }

        // Lancer le script à l'exécution de la page
        fetchData();
    </script>
</body>
</html>
